@model DashboardViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Text.Json
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Dashboard"];
}

<style>
    .goal-item {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0,0,0,0.05) !important;
    }
    .goal-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.08) !important;
        border-color: rgba(37, 117, 252, 0.2) !important;
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    [data-theme="dark"] .glass-card {
        background: rgba(22, 27, 34, 0.7) !important;
    }
    .progress-bar {
        transition: width 1s ease-in-out;
    }
    .pulse-warning {
        animation: pulse-orange 2s infinite;
    }
    @@keyframes pulse-orange {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }
    .status-badge-float {
        position: absolute;
        top: -10px;
        right: 15px;
        z-index: 5;
    }
    .analytic-card {
        transition: transform 0.3s ease;
    }
    .analytic-card:hover {
        transform: scale(1.02);
    }
    .goal-logs-container {
        height: 260px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.1) transparent;
    }
    .goal-logs-container::-webkit-scrollbar {
        width: 6px;
    }
    .goal-logs-container::-webkit-scrollbar-track {
        background: transparent;
    }
    .goal-logs-container::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
    }
    .goal-logs-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.2);
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">@Localizer["Welcome"], @(User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? User.Identity?.Name)!</h1>
        <div class="d-flex gap-2 align-items-center">

            @if (User.IsInRole("Admin"))
            {
                <a asp-controller="User" asp-action="UserList" class="btn btn-outline-primary rounded-pill px-4">
                    <i class="bi bi-people-fill me-2"></i> @Localizer["Manage Users"]
                </a>
            }
        </div>
    </div>
    
    <div class="row g-4">
        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Weather Details"))
        {
            <!-- Weather Card -->
            <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-cloud-sun-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Weather Details"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Real-time climate"]</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-grow-1">
                        <div id="weather-content" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">@Localizer["Loading..."]</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="location-input" class="form-control border-0 px-3" placeholder="@Localizer["Search city..."]" onkeydown="if(event.key==='Enter'){event.preventDefault(); updateWeather();}">
                            <button type="button" onclick="updateWeather()" class="btn btn-primary border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Currency Conversion"))
        {
            <!-- Currency Conversion Card -->
            <div class="col-md-4">
    
    
                <div class="card h-100 shadow border-0 rounded-4 glass-card">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                    <i class="bi bi-currency-exchange"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Currency Conversion"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Global exchange rates"]</p>
                                </div>
                            </div>
                        </div>
    
                        <div class="flex-grow-1">
                            <div class="input-group input-group-sm mb-3 shadow-sm rounded-pill overflow-hidden">
                                <span class="input-group-text border-0 bg-light px-3 small">@Localizer["Amount"]</span>
                                <input type="number" id="amount" class="form-control border-0 text-center fw-bold" value="1">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col">
                                    <select id="from-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                        <option value="USD" selected>USD</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <select id="to-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                        <option value="INR" selected>INR</option>
                                    </select>
                                </div>
                            </div>
                            <div id="currency-result" class="text-center py-3 bg-success bg-opacity-10 rounded-4 border border-success border-opacity-10 mb-3" style="min-height: 80px;"></div>
                        </div>
    
                        <button onclick="convertCurrency()" class="btn btn-success w-100 rounded-pill shadow-sm fw-bold py-2 mt-auto">
                            <i class="bi bi-arrow-repeat me-2"></i>@Localizer["Convert"]
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Time Conversion"))
        {
            <!-- Time Conversion Card -->
            <div class="col-md-4">
    
    
                <div class="card h-100 shadow border-0 rounded-4 glass-card overflow-visible">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-info text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                    <i class="bi bi-clock-fill"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Time Conversion"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["World clock"]</p>
                                </div>
                            </div>
                        </div>
    
                        <div class="flex-grow-1">
                            <div class="text-center mb-4 p-3 bg-light rounded-4 border">
                                <label class="form-label smaller text-muted text-uppercase fw-bold mb-2 ls-1">@Localizer["Current Local Time"]</label>
                                <div id="local-time" class="fw-bold fs-2 text-info"></div>
                            </div>
    
                            <div class="position-relative mb-4">
                                <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border">
                                    <span class="input-group-text border-0 bg-white ps-3"><i class="bi bi-search text-muted"></i></span>
                                    <input type="text" id="timezone-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country, city..."]" oninput="handleGlobalSearch()">
                                </div>
                                <div id="search-results" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none" style="position: absolute; width:100%; z-index: 1000; max-height: 200px; overflow-y: auto; background: var(--card-bg, white); margin-top: 5px; border: 1px solid var(--card-border, #eee);">
                                </div>
                            </div>
    
                            <div id="target-time-card" class="p-3 bg-info bg-opacity-10 border border-info border-opacity-10 rounded-4 text-center">
                                <div id="target-location-display" class="smaller fw-bold text-uppercase mb-1 ls-1">UTC (GMT)</div>
                                <div id="target-time" class="fw-bold fs-3 text-info">-- : -- : --</div>
                                <div id="target-date" class="smaller fw-medium mt-1"></div>
                                <div id="relative-day" class="badge rounded-pill mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Headlines / News"))
        {
            <!-- News Card -->
            <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-newspaper"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Headlines"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Latest world updates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <span class="badge bg-soft-danger text-danger rounded-pill px-3 py-1 small fw-bold">
                                <i class="bi bi-globe2 me-1"></i> @Localizer["Global Feed"]
                            </span>
                            <button class="btn btn-link btn-sm text-muted p-0" onclick="fetchNews('')" title="@Localizer["Reset Feed"]">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border">
                            <input type="text" id="news-global-search" class="form-control border-0 px-3" placeholder="@Localizer["Search global news..."]" style="font-size: 0.8rem;" onkeydown="if(event.key==='Enter'){event.preventDefault(); fetchNews(this.value);}">
                            <button type="button" onclick="fetchNews(document.getElementById('news-global-search').value)" class="btn btn-danger border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="news-container" class="flex-grow-1 overflow-auto pe-1" style="max-height: 400px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">@Localizer["Fetching global news..."]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("World Countries"))
        {
            <!-- Country Search Card -->
            <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background-color: #6610f2 !important;">
                                <i class="bi bi-globe"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["World Countries"]</h6>
                                <p class="text-muted small mb-0">@Localizer["All Country Details"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="country-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search country..."]" oninput="filterCountries(this.value)">
                            <button type="button" onclick="showCountryList()" class="btn btn-primary border-0 px-3" style="background-color: #6610f2 !important;">
                                <i class="bi bi-x-lg" id="country-search-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="country-container" class="flex-grow-1 overflow-auto" style="max-height: 350px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        </div>
    }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Personal Notes"))
        {
            <!-- Notes Card (New Widget) -->
            <div class="col-md-4">
                <div class="card h-100 shadow border-0 rounded-4 glass-card position-relative overflow-hidden">
                    @if (!Model.IsNotesVerified)
                    {
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 10; backdrop-filter: blur(5px);">
                            <div class="icon-circle bg-secondary text-white mb-3 shadow-sm" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                <i class="bi bi-shield-lock-fill"></i>
                            </div>
                            <h5 class="fw-bold text-dark mb-1">@Localizer["Locked"]</h5>
                            @if (Model.HasSecurityPin)
                            {
                                <p class="text-muted small mb-3">@Localizer["Enter PIN to view"]</p>
                                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="showPinModal('Notes')">
                                    <i class="bi bi-key-fill me-2"></i> @Localizer["Unlock"]
                                </button>
                            }
                            else
                            {
                                 <p class="text-muted small mb-3 px-4 text-center">@Localizer["Security PIN not configured"]</p>
                            }
                        </div>
                    }
                    <div class="card-body p-4 d-flex flex-column" style="@(!Model.IsNotesVerified ? "filter: blur(5px); pointer-events: none;" : "")">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-warning text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                    <i class="bi bi-sticky-fill"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Personal Notes"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Capture your thoughts"]</p>
                                </div>
                            </div>
                            @if (!User.IsInRole("Visitor"))
                            {
                                <button class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold text-white" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                                    <i class="bi bi-plus-lg me-2"></i> @Localizer["Add Note"]
                                </button>
                            }
                        </div>

                        <div id="notes-container" class="row g-3">
                            @if (Model.Notes.Any())
                            {
                                @foreach (var note in Model.Notes)
                                {
                                    <div class="col-12">
                                        <div class="note-item h-100 p-3 rounded-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 shadow-sm d-flex flex-column">
                                            <div class="p-2 flex-grow-1 text-dark small" style="white-space: pre-wrap; font-family: 'Inter', sans-serif;">@note.Text</div>
                                            <div class="mt-3 pt-3 border-top border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                                <span class="smaller text-muted">
                                                    <i class="bi bi-clock me-1"></i> @note.CreatedAt.ToString("MMM dd, HH:mm")
                                                </span>
                                                <div class="btn-group">
                                                    @if (!User.IsInRole("Visitor"))
                                                    {
                                                        <button class="btn btn-link btn-sm text-dark p-0 me-2" onclick="openEditModal(@note.Id, `@(note.Text.Replace("`", "\\`"))`)"><i class="bi bi-pencil"></i></button>
                                                        <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteNote(@note.Id)"><i class="bi bi-trash"></i></button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12 text-center py-5">
                                    <div class="text-muted mb-2 opacity-25"><i class="bi bi-journal-text" style="font-size: 3rem;"></i></div>
                                    <p class="text-muted">@Localizer["No notes yet. Click 'Add Note' to start writing."]</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Habit Tracker"))
        {
            <!-- Habit Tracker Card -->
            <div class="col-md-4">
                <div class="card h-100 shadow border-0 rounded-4 glass-card position-relative overflow-hidden">
                    @if (!Model.IsHabitsVerified)
                    {
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 10; backdrop-filter: blur(5px);">
                            <div class="icon-circle bg-secondary text-white mb-3 shadow-sm" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                <i class="bi bi-shield-lock-fill"></i>
                            </div>
                            <h5 class="fw-bold text-dark mb-1">@Localizer["Locked"]</h5>
                            @if (Model.HasSecurityPin)
                            {
                                <p class="text-muted small mb-3">@Localizer["Enter PIN to view"]</p>
                                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="showPinModal('Habit')">
                                    <i class="bi bi-key-fill me-2"></i> @Localizer["Unlock"]
                                </button>
                            }
                            else
                            {
                                 <p class="text-muted small mb-3 px-4 text-center">@Localizer["Security PIN not configured"]</p>
                            }
                        </div>
                    }
                    <div class="card-body p-4 d-flex flex-column" style="@(!Model.IsHabitsVerified ? "filter: blur(5px); pointer-events: none;" : "")">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Habit Tracker"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Build better habits"]</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-dark rounded-pill px-3 shadow-sm border small fw-bold" data-bs-toggle="modal" data-bs-target="#allHabitsModal" title="@Localizer["View All Saved Habits"]">
                                    <i class="bi bi-list-ul me-1"></i> @Localizer["Stored"]
                                </button>
                                @if (!User.IsInRole("Visitor"))
                                {
                                    <button class="btn btn-success rounded-pill px-4 shadow-sm fw-bold text-white small" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                                        <i class="bi bi-plus-lg me-1"></i> @Localizer["Add"]
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="flex-grow-1">
                            <!-- Daily Progress Bar -->
                            @{
                                var totalHabits = Model.Habits.Count;
                                var completedToday = Model.Habits.Count(h => h.IsCompletedToday);
                                var progress = totalHabits > 0 ? (int)((double)completedToday / totalHabits * 100) : 0;
                            }
                            <div class="mb-4">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="fw-bold text-muted">@Localizer["All Progress"]</span>
                                    <span class="fw-bold text-success">@progress%</span>
                                </div>
                                <div class="progress rounded-pill" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: @progress%" aria-valuenow="@progress" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <!-- Habits List -->
                            <div id="habits-container" class="d-flex flex-column gap-2" style="max-height: 250px; overflow-y: auto;">
                                @if (Model.Habits.Any())
                                {
                                    @foreach (var habit in Model.Habits)
                                    {
                                        bool isScheduledToday = true;
                                        string statusBadge = "";
                                        
                                        // 1. Check Start Date
                                        if (DateTime.Today < habit.StartDate.Date) 
                                        {
                                            isScheduledToday = false;
                                            statusBadge = Localizer["Starts"] + " " + habit.StartDate.ToString("MMM dd");
                                        }
                                        // 2. Check Frequency
                                        else if (habit.Frequency == "Custom" && !habit.CustomDays.Contains(DateTime.Today.DayOfWeek)) 
                                        {
                                            isScheduledToday = false;
                                            statusBadge = string.Join(", ", habit.CustomDays.Select(d => d.ToString().Substring(0, 3)));
                                        }

                                        <div class="habit-item p-3 rounded-4 border d-flex align-items-center justify-content-between @(isScheduledToday ? (habit.IsCompletedToday ? "border-success bg-success bg-opacity-10" : "bg-light") : "bg-light opacity-50")">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" onchange="toggleHabit(@habit.Id)" @(habit.IsCompletedToday ? "checked" : "") @(!isScheduledToday ? "disabled" : "") style="cursor: pointer; width: 1.2em; height: 1.2em;">
                                                </div>
                                                <div>
                                                    <div class="fw-bold text-dark mb-0 form-check-label @(habit.IsCompletedToday ? "text-decoration-line-through text-muted" : "")">
                                                        @habit.Name
                                                        @if (!isScheduledToday)
                                                        {
                                                            <span class="badge bg-secondary ms-2 small" style="font-size: 0.65rem;">@statusBadge</span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(habit.Description))
                                                    {
                                                        <div class="smaller text-muted">@habit.Description</div>
                                                    }
                                                    <!-- Debug/Info about schedule -->
                                                    <div class="smaller text-muted opacity-75" style="font-size: 0.7rem;">
                                                        @{
                                                            var daysAgo = (DateTime.Today - habit.CreatedAt.Date).Days;
                                                            var createdText = daysAgo == 0 ? Localizer["Added today"] : daysAgo == 1 ? Localizer["Added yesterday"] : Localizer["Added {0} days ago", daysAgo];
                                                        }
                                                        <span class="me-2" title="@Localizer["Creation Date"]: @habit.CreatedAt.ToString("d")">
                                                            <i class="bi bi-clock-history me-1"></i>@createdText
                                                        </span>
                                                        <span class="mx-1 opacity-25">|</span>
                                                        <i class="bi bi-calendar-event me-1"></i>
                                                        @(habit.Frequency == "Daily" ? Localizer["Daily"] : string.Join(", ", habit.CustomDays.Select(d => d.ToString().Substring(0, 3))))
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                @if (habit.CurrentStreak > 0)
                                                {
                                                    <span class="badge rounded-pill bg-warning text-dark border border-warning shadow-sm" title="@Localizer["Current Streak"]">
                                                        <i class="bi bi-fire me-1 text-danger"></i>@habit.CurrentStreak
                                                    </span>
                                                }
                                                @if (!User.IsInRole("Visitor"))
                                                {
                                                    <button class="btn btn-link btn-sm text-danger p-0 ms-1 opacity-50 hover-opacity-100" onclick="deleteHabit(@habit.Id)" title="@Localizer["Delete Habit"]">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-center py-4">
                                        <p class="text-muted small mb-0">@Localizer["No habits yet. Start tracking today!"]</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Emergency Numbers"))
        {
            <!-- Emergency Numbers Card -->
            <div class="col-md-4">



            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-shield-fill-plus"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Emergency Numbers"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Lifeline contacts"]</p>
                            </div>
                        </div>
                    </div>
    
                    <div class="flex-grow-1">
                        <div class="mb-4">
                             <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                                <span class="input-group-text border-0 bg-light px-3"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="emergency-country-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country (e.g. India)"]" oninput="filterEmergencyCountries(this.value)">
                            </div>
                            <div id="emergency-country-list" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; background: var(--card-bg, white); margin-top: 5px; border: 1px solid var(--card-border, #eee);">
                                <!-- Populated by JS -->
                            </div>
                        </div>
    
                        <div id="emergency-display" class="d-none">
                            <div class="text-center mb-3">
                                <img id="emergency-flag" src="" class="shadow-sm rounded-2 mb-2" style="width: 40px; height: 30px; object-fit: cover;">
                                <h6 id="emergency-country-name" class="fw-bold mb-0"></h6>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-shield-shaded text-primary me-3 fs-5"></i>
                                            <span class="fw-medium">@Localizer["Police"]</span>
                                        </div>
                                        <div id="emer-police" class="h5 fw-bold text-primary mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-danger bg-opacity-10 border border-danger border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-hospital-fill text-danger me-3 fs-5"></i>
                                            <span class="fw-medium">@Localizer["Ambulance"]</span>
                                        </div>
                                        <div id="emer-ambulance" class="h5 fw-bold text-danger mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-fire text-warning me-3 fs-5"></i>
                                            <span class="fw-medium">@Localizer["Fire"]</span>
                                        </div>
                                        <div id="emer-fire" class="h5 fw-bold text-warning mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-exclamation-triangle-fill text-secondary me-3 fs-5"></i>
                                            <span class="fw-medium">@Localizer["General"]</span>
                                        </div>
                                        <div id="emer-general" class="h5 fw-bold text-secondary mb-0">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="emergency-placeholder" class="text-center py-4 text-muted opacity-50">
                            <i class="bi bi-globe-americas fs-1 d-block mb-2"></i>
                            <span class="small">@Localizer["Select a country to view numbers"]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
        
        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Language Translator"))
        {
            <!-- Language Translator Module -->
            <div class="col-md-4">
                <div class="card h-100 shadow border-0 rounded-4 glass-card position-relative overflow-hidden">
                     <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%) !important;">
                                    <i class="bi bi-translate"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Language Translator"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Select languages, then translate"]</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex-grow-1">
                            <!-- Step 1 & 2: Language Selection -->
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="smaller text-muted fw-bold text-uppercase ls-1 mb-1 ms-1">@Localizer["Input"]</label>
                                    <select id="translator-source-lang" class="form-select form-select-sm rounded-pill border-0 shadow-sm bg-light px-3" onchange="updateTranslatorState()" style="font-size: 0.8rem;">
                                        <option value="" disabled selected>@Localizer["From..."]</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="smaller text-muted fw-bold text-uppercase ls-1 mb-1 ms-1">@Localizer["Output"]</label>
                                    <select id="translator-target-lang" class="form-select form-select-sm rounded-pill border-0 shadow-sm bg-light px-3" onchange="updateTranslatorState()" style="font-size: 0.8rem;">
                                        <option value="" disabled selected>@Localizer["To..."]</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <!-- Step 3: Text Input -->
                            <div class="mb-3">
                                <textarea id="translator-input" class="form-control rounded-4 bg-light border-0 shadow-sm p-3 small" rows="3" placeholder="@Localizer["Select input language first..."]" disabled></textarea>
                            </div>
                            
                            <div class="text-center mb-3">
                                <button type="button" onclick="performManualTranslation()" id="translator-btn" class="btn btn-dark rounded-pill px-5 shadow-sm fw-bold btn-sm" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%) !important; border: none;" disabled>
                                    @Localizer["Translate Now"]
                                </button>
                            </div>

                            <div id="translator-result-container" class="d-none">
                                <div class="p-3 rounded-4 bg-primary bg-opacity-10 border border-primary border-opacity-10 position-relative">
                                    <label class="smaller fw-bold text-primary text-uppercase mb-2 d-block ls-1">@Localizer["Translation"]</label>
                                    <div id="translator-output" class="fw-medium" style="white-space: pre-wrap;"></div>
                                </div>
                            </div>
                            
                            <div id="translator-error" class="alert alert-danger py-2 px-3 rounded-pill smaller d-none mt-2">
                                 <i class="bi bi-exclamation-circle me-1"></i> <span id="translator-error-msg"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        
        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("PDF Converter"))
        {
            <!-- PDF Converter Card -->
            <div class="col-md-4">
                <div class="card h-100 shadow border-0 rounded-4 glass-card position-relative overflow-hidden">
                    @if (!Model.IsPdfVerified)
                    {
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 10; backdrop-filter: blur(5px);">
                            <div class="icon-circle bg-secondary text-white mb-3 shadow-sm" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                <i class="bi bi-shield-lock-fill"></i>
                            </div>
                            <h5 class="fw-bold text-dark mb-1">@Localizer["Locked"]</h5>
                            @if (Model.HasSecurityPin)
                            {
                                <p class="text-muted small mb-3">@Localizer["Enter PIN to view"]</p>
                                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="showPinModal('PDF')">
                                    <i class="bi bi-key-fill me-2"></i> @Localizer["Unlock"]
                                </button>
                            }
                            else
                            {
                                 <p class="text-muted small mb-3 px-4 text-center">@Localizer["Security PIN not configured"]</p>
                            }
                        </div>
                    }
                    <div class="card-body p-4 d-flex flex-column" style="@(!Model.IsPdfVerified ? "filter: blur(5px); pointer-events: none;" : "")">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%) !important;">
                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["PDF Converter"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Convert images to PDF"]</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex-grow-1 d-flex flex-column">
                            <div class="row g-2 mb-3">
                                <div class="col-12">
                                    <label for="image-format-select" class="form-label smaller text-muted fw-bold text-uppercase ls-1">@Localizer["Step 1: Select Format"]</label>
                                    <select id="image-format-select" class="form-select form-select-sm rounded-pill bg-light border-0 px-3 py-2" onchange="updateUploadAccept(this.value)">
                                        <option value="image/jpeg,image/png" selected>@Localizer["All Images"] (JPG & PNG)</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="image-upload" class="form-label smaller text-muted fw-bold text-uppercase ls-1">@Localizer["Step 2: Upload Images"]</label>
                                    <input class="form-control form-control-sm rounded-pill bg-light border-0 px-3 py-2" type="file" id="image-upload" accept="image/jpeg" multiple onchange="previewImage(this)">
                                </div>
                                <div class="col-12">
                                    <label for="pdf-margin-select" class="form-label smaller text-muted fw-bold text-uppercase ls-1">@Localizer["Step 3: Page Margin"]</label>
                                    <select id="pdf-margin-select" class="form-select form-select-sm rounded-pill bg-light border-0 px-3 py-2">
                                        <option value="0">@Localizer["No Margin"]</option>
                                        <option value="10">@Localizer["Small"] (10mm)</option>
                                        <option value="20" selected>@Localizer["Medium"] (20mm)</option>
                                        <option value="40">@Localizer["Large"] (40mm)</option>
                                    </select>
                                </div>
                            </div>

                            <div id="image-format-error" class="alert alert-danger py-2 px-3 rounded-pill smaller d-none mb-3">
                                <i class="bi bi-exclamation-circle me-1"></i> @Localizer["One or more files do not match the selected format."]
                            </div>

                            <div id="selected-files-container" class="mb-3 d-none p-3 rounded-4 bg-light border border-dashed flex-grow-1" style="min-height: 100px;">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-files me-2 text-primary"></i>
                                    <span id="files-count-badge" class="badge rounded-pill bg-primary fw-bold">0 @Localizer["images selected"]</span>
                                </div>
                                <div id="selected-files-list" class="smaller text-muted overflow-auto" style="max-height: 150px; line-height: 1.4;"></div>
                            </div>

                            <div id="pdf-result-container" class="d-none mt-auto">
                                <div class="p-3 rounded-4 bg-success bg-opacity-10 border border-success border-opacity-25 mb-3 text-center">
                                    <div class="small fw-bold text-success mb-2 text-uppercase ls-1">@Localizer["PDF Ready!"]</div>
                                    <div class="d-flex gap-2">
                                        <button type="button" onclick="openPdfInNewTab()" class="btn btn-outline-success btn-sm rounded-pill flex-grow-1 fw-bold">
                                            <i class="bi bi-eye me-1"></i> @Localizer["View"]
                                        </button>
                                        <button type="button" onclick="downloadPdf()" class="btn btn-success btn-sm rounded-pill flex-grow-1 fw-bold">
                                            <i class="bi bi-download me-1"></i> @Localizer["Download"]
                                        </button>
                                    </div>
                                </div>
                                <button type="button" onclick="resetPdfConverter()" class="btn btn-link btn-sm w-100 text-decoration-none text-muted">
                                    <i class="bi bi-arrow-counterclockwise"></i> @Localizer["Convert another"]
                                </button>
                            </div>

                            <div id="convert-btn-container" class="d-grid gap-2 mt-auto">
                                <button type="button" id="convert-to-pdf-btn" onclick="convertToPdf()" class="btn btn-primary rounded-pill py-2 shadow-sm fw-bold border-0" style="background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%) !important;" disabled>
                                    @Localizer["Merge to PDF"]
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || Model.PermittedWidgets.Contains("Goal Tracking"))
        {
            <!-- Advanced Goal Tracking Card -->
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow border-0 rounded-4 glass-card position-relative overflow-hidden">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%) !important;">
                                    <i class="bi bi-rocket-takeoff-fill"></i>
                                </div>
                                <div>
                                    <h6 class="card-title fw-bold mb-0">@Localizer["Smart Goal Tracker"]</h6>
                                    <p class="text-muted small mb-0">@Localizer["Performance Analytics"]</p>
                                </div>
                            </div>
                            @if (!User.IsInRole("Visitor"))
                            {
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary rounded-pill px-3 shadow-sm fw-bold border-0 me-2" style="background: rgba(106, 17, 203, 0.1);" onclick="openAnalytics()">
                                        <i class="bi bi-bar-chart-fill"></i>
                                    </button>
                                    <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold text-white border-0" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%) !important;" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                                        <i class="bi bi-plus-lg me-2"></i> @Localizer["Target"]
                                    </button>
                                </div>
                            }
                        </div>

                        <!-- Mini Stats Dashboard -->
                        <div class="row g-2 mb-3">
                            <div class="col-4">
                                <div class="p-2 rounded-3 bg-light border text-center">
                                    <div class="smaller text-muted fw-bold text-uppercase" style="font-size: 0.5rem;">@Localizer["Total"]</div>
                                    <div class="fw-bold text-dark mb-0">@Model.TotalGoals</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-25 text-center">
                                    <div class="smaller text-success fw-bold text-uppercase" style="font-size: 0.5rem;">@Localizer["Done"]</div>
                                    <div class="fw-bold text-success mb-0">@Model.CompletedGoals</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 text-center">
                                    <div class="smaller text-danger fw-bold text-uppercase" style="font-size: 0.5rem;">@Localizer["Late"]</div>
                                    <div class="fw-bold text-danger mb-0">@Model.OverdueGoals</div>
                                </div>
                            </div>
                        </div>

                        <div id="goals-container" class="row g-3 flex-grow-1" style="max-height: 500px; overflow-y: auto; overflow-x: hidden;">
                            @if (Model.RecentGoals.Any())
                            {
                                @foreach (var goal in Model.RecentGoals) 
                                {
                                    <div class="col-12">
                                        <div class="goal-item p-3 rounded-4 bg-light bg-opacity-50 border shadow-sm">
                                            <!-- Title & Status -->
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div class="d-flex align-items-center gap-2">
                                                    <h6 class="fw-bold mb-0 @(goal.IsCompleted ? "text-decoration-line-through text-muted" : "text-dark")">@goal.Title</h6>
                                                    <span class="badge rounded-pill bg-white border text-muted" style="font-size: 0.6rem;">@goal.Category</span>
                                                </div>
                                                <span class="badge rounded-pill @goal.StatusColor shadow-sm">@Localizer[goal.Status]</span>
                                            </div>

                                            <!-- Live Countdown Timer -->
                                            <div class="countdown-timer text-center p-2 rounded-3 bg-dark text-white mb-3 shadow-sm" data-end-date="@goal.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")" id="timer-@goal.Id">
                                                <div class="row g-0">
                                                    <div class="col-4 border-end border-secondary border-opacity-25">
                                                        <span class="d-block h6 fw-bold mb-0 days">00</span>
                                                        <span class="smaller opacity-50 text-uppercase" style="font-size: 0.5rem;">@Localizer["Days"]</span>
                                                    </div>
                                                    <div class="col-4 border-end border-secondary border-opacity-25">
                                                        <span class="d-block h6 fw-bold mb-0 hours">00</span>
                                                        <span class="smaller opacity-50 text-uppercase" style="font-size: 0.5rem;">@Localizer["Hours"]</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <span class="d-block h6 fw-bold mb-0 minutes">00</span>
                                                        <span class="smaller opacity-50 text-uppercase" style="font-size: 0.5rem;">@Localizer["Mins"]</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Progress Bar -->
                                            <div class="d-flex justify-content-between align-items-end mb-1">
                                                <span class="smaller fw-bold text-uppercase ls-1" style="font-size: 0.6rem;">@Localizer["Overall Progress"]</span>
                                                <span class="smaller fw-bold text-primary">@goal.ProgressPercentage.ToString("F1")%</span>
                                            </div>
                                            <div class="progress rounded-pill mb-3" style="height: 10px; background-color: rgba(0,0,0,0.05);">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated @goal.StatusColor shadow-sm" role="progressbar" style="width: @goal.ProgressPercentage.ToString().Replace(',', '.')%" aria-valuenow="@goal.ProgressPercentage.ToString().Replace(',', '.')" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>

                                            <!-- Daily Target Calculator -->
                                            <div class="p-2 rounded-3 bg-white border mb-3 text-center">
                                                <div class="smaller text-muted text-uppercase fw-bold ls-1" style="font-size: 0.55rem;">@Localizer["Daily Target required"]</div>
                                                <div class="h6 fw-bold text-primary mb-0">@goal.RequiredVelocity.ToString("F1") <span class="smaller text-muted fw-normal">/ day</span></div>
                                            </div>

                                            <!-- Auto-Generated Daily Log System -->
                                            <div class="daily-logs-system mb-3">
                                                <div class="btn-group w-100 mb-2">
                                                    <button class="btn btn-outline-secondary btn-sm rounded-start-pill py-1 border-dashed" type="button" data-bs-toggle="collapse" data-bs-target="#logs-@goal.Id" style="font-size: 0.65rem;">
                                                        <i class="bi bi-calendar3 me-1"></i> @Localizer["Logs"]
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm rounded-end-pill py-1 border-dashed" type="button" data-bs-toggle="collapse" data-bs-target="#graph-collapse-@goal.Id" style="font-size: 0.65rem;" onclick="initGoalChart(@goal.Id, @JsonSerializer.Serialize(goal.DailyLogs.OrderBy(l => l.Date).Select(l => l.Date.ToString("MMM dd"))), @JsonSerializer.Serialize(goal.DailyLogs.OrderBy(l => l.Date).Select(l => l.Target)), @JsonSerializer.Serialize(goal.DailyLogs.OrderBy(l => l.Date).Select(l => l.Actual)))">
                                                        <i class="bi bi-graph-up me-1"></i> @Localizer["Stats"]
                                                    </button>
                                                </div>
                                                <div class="collapse" id="graph-collapse-@goal.Id">
                                                    <div class="p-2 bg-white rounded-4 border shadow-sm mb-2" style="height: 150px;">
                                                        <canvas id="graph-@goal.Id"></canvas>
                                                    </div>
                                                </div>
                                                <div class="collapse" id="logs-@goal.Id">
                                                    <div class="list-group list-group-flush border rounded-4 shadow-sm bg-white goal-logs-container">
                                                        @foreach (var log in goal.DailyLogs.OrderByDescending(l => l.Date))
                                                        {
                                                            <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-3 @(log.IsToday ? "bg-primary bg-opacity-10" : "")">
                                                                <div>
                                                                    <div class="fw-bold smaller @(log.IsToday ? "text-primary" : "")">@log.Date.ToString("MMM dd") @(log.IsToday ? "(" + Localizer["Today"] + ")" : "")</div>
                                                                    <div class="smaller text-muted" style="font-size: 0.6rem;">@Localizer["Target"]: @log.Target.ToString("F1")</div>
                                                                </div>
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <input type="number" class="form-control form-control-sm text-center fw-bold p-1" value="@log.Actual.ToString().Replace(',', '.')" 
                                                                           style="width: 50px; font-size: 0.7rem;" 
                                                                           onchange="updateDailyLog(@goal.Id, '@log.Date.ToString("yyyy-MM-dd")', this.value)">
                                                                    @if (log.Actual >= log.Target)
                                                                    {
                                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                                    }
                                                                    else if (log.IsPast && log.Actual < log.Target)
                                                                    {
                                                                        <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.7rem;"></i>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Smart Status Indicator -->
                                            <div class="smart-suggestion p-2 rounded-3 mb-3 border border-dashed @(goal.Status == "At Risk" || goal.Status == "Behind" ? "bg-warning bg-opacity-10 border-warning" : "bg-light")">
                                                <div class="d-flex gap-2 align-items-center">
                                                    <i class="bi bi-lightbulb-fill @(goal.Status == "At Risk" || goal.Status == "Behind" ? "text-warning" : "text-primary")"></i>
                                                    <div class="smaller text-dark lh-sm" style="font-size: 0.65rem;">
                                                        <span class="fw-bold text-uppercase ls-1">@Localizer["Coach Advice"]:</span> @goal.SmartSuggestion
                                                        @if (goal.Status == "At Risk" || goal.Status == "Behind" || goal.Status == "Late")
                                                        {
                                                            <br/>
                                                            <button class="btn btn-link btn-sm p-0 smaller text-warning mt-1 text-decoration-none fw-bold" onclick="extendDeadline(@goal.Id)">
                                                                <i class="bi bi-calendar-plus me-1"></i>@Localizer["Need more time? Extend Deadline"]
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Actions Area -->
                                            <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-dashed">
                                                @if (!User.IsInRole("Visitor"))
                                                {
                                                    <button class="btn btn-sm rounded-pill px-3 fw-bold @(goal.IsCompleted ? "btn-success shadow-success" : "btn-outline-success")" onclick="toggleGoalCompletion(@goal.Id)" style="font-size: 0.7rem;">
                                                        @if (goal.IsCompleted) {
                                                            <i class="bi bi-check-circle-fill me-1"></i> @Localizer["Finished"]
                                                        } else {
                                                            <i class="bi bi-check2 me-1"></i> @Localizer["Complete"]
                                                        }
                                                    </button>
                                                    <div class="btn-group">
                                                        <button class="btn btn-link btn-sm text-info p-0 me-2" onclick="openEditGoalModal(@goal.Id, '@goal.Title.Replace("'", "\\'")', '@goal.StartDate.ToString("yyyy-MM-dd")', '@goal.EndDate.ToString("yyyy-MM-dd")', '@goal.Category', '@goal.Priority', '@goal.Difficulty', @goal.TargetValue.ToString().Replace(',', '.'), @goal.CurrentValue.ToString().Replace(',', '.'))" title="@Localizer["Edit"]">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                        <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteGoal(@goal.Id)" title="@Localizer["Remove"]">
                                                            <i class="bi bi-trash3"></i>
                                                        </button>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted smaller"><i class="bi bi-eye me-1"></i>@Localizer["Read Only"]</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12 text-center py-5">
                                    <div class="text-muted mb-2 opacity-25"><i class="bi bi-rocket-takeoff" style="font-size: 3rem;"></i></div>
                                    <p class="text-muted">@Localizer["No active missions. Ignite your potential!"]</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        </div>
    </div>



<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg overflow-hidden">
            <div class="modal-header border-0 text-white p-4" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%) !important;">
                <h5 class="modal-title fw-bold" id="addGoalModalLabel"><i class="bi bi-rocket me-2"></i> @Localizer["Set New Target"]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <form id="addGoalForm" onsubmit="saveNewGoal(event)">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Goal Title"]</label>
                        <input type="text" name="Title" class="form-control rounded-3 border-0 shadow-sm p-3" placeholder="@Localizer["What do you want to achieve?"]" required minlength="3">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Start Date"]</label>
                            <input type="date" id="addGoalStart" name="StartDate" class="form-control rounded-3 border-0 shadow-sm p-3" value="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Deadline"]</label>
                            <input type="date" id="addGoalEnd" name="EndDate" class="form-control rounded-3 border-0 shadow-sm p-3" value="@DateTime.Now.AddDays(7).ToString("yyyy-MM-dd")" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Category"]</label>
                            <select name="Category" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Personal">Personal</option>
                                <option value="Work">Work</option>
                                <option value="Health">Health</option>
                                <option value="Finance">Finance</option>
                                <option value="Study">Study</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Priority"]</label>
                            <select name="Priority" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Difficulty"]</label>
                            <select name="Difficulty" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Target Value (Total)"]</label>
                        <div class="input-group">
                            <span class="input-group-text border-0 bg-white rounded-start-3 p-3"><i class="bi bi-bullseye text-primary"></i></span>
                            <input type="number" id="addGoalTarget" name="TargetValue" class="form-control border-0 shadow-sm p-3" value="100" step="0.01" required>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary rounded-pill py-3 fw-bold shadow border-0" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%) !important;">
                            @Localizer["Launch Mission"]
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-labelledby="editGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg overflow-hidden">
            <div class="modal-header border-0 text-white p-4" style="background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%) !important;">
                <h5 class="modal-title fw-bold" id="editGoalModalLabel"><i class="bi bi-pencil-square me-2"></i> @Localizer["Modify Mission"]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <form id="editGoalForm" onsubmit="saveEditedGoal(event)">
                    <input type="hidden" id="editGoalId" name="Id">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Goal Title"]</label>
                        <input type="text" id="editGoalTitle" name="Title" class="form-control rounded-3 border-0 shadow-sm p-3" required minlength="3">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Start Date"]</label>
                            <input type="date" id="editGoalStart" name="StartDate" class="form-control rounded-3 border-0 shadow-sm p-3" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Deadline"]</label>
                            <input type="date" id="editGoalEnd" name="EndDate" class="form-control rounded-3 border-0 shadow-sm p-3" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Category"]</label>
                            <select id="editGoalCategory" name="Category" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Personal">Personal</option>
                                <option value="Work">Work</option>
                                <option value="Health">Health</option>
                                <option value="Finance">Finance</option>
                                <option value="Study">Study</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Priority"]</label>
                            <select id="editGoalPriority" name="Priority" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Difficulty"]</label>
                            <select id="editGoalDifficulty" name="Difficulty" class="form-select rounded-3 border-0 shadow-sm p-3">
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold small text-muted text-uppercase">@Localizer["Target Value (Total)"]</label>
                            <input type="number" id="editGoalTarget" name="TargetValue" class="form-control rounded-3 border-0 shadow-sm p-3" step="0.01" required>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-info rounded-pill py-3 fw-bold shadow text-white border-0" style="background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%) !important;">
                            @Localizer["Save Changes"]
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="addNoteModalLabel">@Localizer["Add New Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="new-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="saveNewNote()">@Localizer["Save Note"]</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="editNoteModalLabel">@Localizer["Edit Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id" />
                <textarea id="edit-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="updateNote()">@Localizer["Save Changes"]</button>
            </div>
        </div>
    </div>
</div>

    <!-- All Habits Modal (Stored Habits) -->
    <div class="modal fade" id="allHabitsModal" tabindex="-1" aria-labelledby="allHabitsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="allHabitsModalLabel">@Localizer["All Saved Habits"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 rounded-start ps-3">@Localizer["Habit Name"]</th>
                                    <th class="border-0">@Localizer["Frequency"]</th>
                                    <th class="border-0">@Localizer["Created"]</th>
                                    <th class="border-0 rounded-end pe-3 text-end">@Localizer["Status (Today)"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Habits.Any())
                                {
                                    @foreach (var habit in Model.Habits.OrderByDescending(h => h.CreatedAt))
                                    {
                                        <tr>
                                            <td class="ps-3 border-0">
                                                <div class="fw-bold text-dark">@habit.Name</div>
                                                @if (!string.IsNullOrEmpty(habit.Description))
                                                {
                                                    <div class="smaller text-muted">@habit.Description</div>
                                                }
                                            </td>
                                            <td class="border-0">
                                                <span class="badge bg-light text-dark border">
                                                    @(habit.Frequency == "Daily" ? Localizer["Daily"] : string.Join(", ", habit.CustomDays.Select(d => d.ToString().Substring(0, 3))))
                                                </span>
                                            </td>
                                            <td class="border-0">
                                                 @{
                                                    var daysAgo = (DateTime.Today - habit.CreatedAt.Date).Days;
                                                    var createdText = daysAgo == 0 ? Localizer["Today"] : daysAgo == 1 ? Localizer["Yesterday"] : Localizer["{0} days ago", daysAgo];
                                                }
                                                <span class="smaller text-muted">@createdText</span>
                                            </td>
                                            <td class="border-0 text-end pe-3">
                                                @if (habit.IsCompletedToday)
                                                {
                                                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 py-2">
                                                        <i class="bi bi-check-circle-fill me-1"></i> @Localizer["Completed"]
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill px-3 py-2">
                                                        <i class="bi bi-clock me-1"></i> @Localizer["Pending"]
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5 border-0 text-muted">
                                            @Localizer["No habits found."]
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Close"]</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Habit Modal -->
    <div class="modal fade" id="addHabitModal" tabindex="-1" aria-labelledby="addHabitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="addHabitModalLabel">@Localizer["Add New Habit"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="habit-name" class="form-label small fw-bold text-muted">@Localizer["Habit Name"]</label>
                        <input type="text" id="habit-name" class="form-control rounded-pill bg-light border-0 px-3" placeholder="@Localizer["e.g., Drink Water, Read Book"]">
                    </div>
                    <div class="mb-3">
                        <label for="habit-desc" class="form-label small fw-bold text-muted">@Localizer["Description (Optional)"]</label>
                        <input type="text" id="habit-desc" class="form-control rounded-pill bg-light border-0 px-3" placeholder="@Localizer["e.g., 2 liters daily"]">
                    </div>
                     
                    <!-- Frequency Selection -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">@Localizer["Frequency"]</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="habitFrequency" id="freqDaily" value="Daily" checked onchange="toggleCustomDays(false)">
                                <label class="form-check-label" for="freqDaily">@Localizer["Daily"]</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="habitFrequency" id="freqCustom" value="Custom" onchange="toggleCustomDays(true)">
                                <label class="form-check-label" for="freqCustom">@Localizer["Custom Days"]</label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Days Checkboxes -->
                    <div id="customDaysContainer" class="mb-3 d-none p-3 bg-light rounded-4">
                         <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                            {
                                 // Skip 0 (Sunday) to put it at end if preferred, or just list them. Let's list Mon-Sun or Sun-Sat. Standard Enum is Sun=0.
                                 // Let's rely on standard enum order but maybe display nicer short names.
                                 <div class="form-check form-check-inline">
                                    <input class="form-check-input custom-day-check" type="checkbox" id="day-@day" value="@day">
                                    <label class="form-check-label small" for="day-@day">@day.ToString().Substring(0, 3)</label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Start Date -->
                    <div class="mb-3">
                        <label for="habit-start-date" class="form-label small fw-bold text-muted">@Localizer["Start Date"]</label>
                        <input type="date" id="habit-start-date" class="form-control rounded-pill bg-light border-0 px-3">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="button" class="btn btn-success rounded-pill px-4 text-white fw-bold" onclick="saveNewHabit()">@Localizer["Create Habit"]</button>
                </div>
            </div>
        </div>
    </div>

<style>
    /* glass-card moved to site.css for theme support */
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    body {
        min-height: 100vh;
    }
    #timezone-select {
        max-height: 200px;
    }

    /* Currency Enhancements */
    .currency-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .flag-icon {
        width: 20px;
        height: 15px;
        object-fit: cover;
        border-radius: 2px;
    }
    #currency-result {
        background: rgba(25, 135, 84, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }

    /* Time Enhancements */
    #target-time-card {
        transition: all 0.3s ease;
    }
    .badge-today { background-color: #0dcaf0; color: white; }
    .badge-yesterday { background-color: #6c757d; color: white; }
    .badge-tomorrow { background-color: #198754; color: white; }

    /* News Enhancements */
    .object-fit-cover { object-fit: cover; }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .hover-shadow { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .carousel-item { transition: transform 0.6s ease-in-out; }
    .carousel-indicators [data-bs-target] { background-color: #dc3545; }
    .carousel-control-prev-icon, .carousel-control-next-icon { filter: invert(1) grayscale(100); }

    /* Note Enhancements */
    .note-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: default;
    }
    .note-item:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .smaller { font-size: 0.75rem; }
    .ls-1 { letter-spacing: 1px; }

</style>






<script>
</script>

@section Scripts {
    <!-- Security PIN Modal -->
    <div class="modal fade" id="pinModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-body p-4 text-center">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.5rem;">
                        <i class="bi bi-shield-lock"></i>
                    </div>
                    <h5 class="fw-bold mb-1">@Localizer["Security Check"]</h5>
                    <p class="text-muted small mb-3">@Localizer["Please enter your PIN"]</p>
                    
                    <div class="mb-3">
                        <input type="password" id="security-pin-input" class="form-control form-control-lg text-center fw-bold letter-spacing-2 rounded-pill bg-light border-0" maxlength="6" placeholder="" onkeydown="if(event.key==='Enter') submitPin()">
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100 rounded-pill fw-bold shadow-sm" onclick="submitPin()">@Localizer["Verify"]</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="~/js/emergency_data.js"></script>
    <script>
        // --- Security PIN Logic ---
        let currentLockWidget = '';

        function showPinModal(widgetName = '') {
            currentLockWidget = widgetName;
            const modal = new bootstrap.Modal(document.getElementById('pinModal'));
            modal.show();
            setTimeout(() => document.getElementById('security-pin-input').focus(), 500);
        }

        async function submitPin() {
            const pin = document.getElementById('security-pin-input').value;
            if (!pin) return;

            try {
                const response = await fetch('/Dashboard/VerifyPin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `pin=${encodeURIComponent(pin)}&widgetName=${encodeURIComponent(currentLockWidget)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message || '@Localizer["Incorrect PIN"]');
                    document.getElementById('security-pin-input').value = '';
                }
            } catch (error) {
                console.error('PIN verification error:', error);
            }
        }

        // --- Weather Logic ---
        async function detectLocationAndFetchWeather() {
            const content = document.getElementById('weather-content');
            
            // Show detecting spinner
            content.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">@Localizer["Loading..."]</span>
                    </div>
                    <p class="text-secondary fw-medium mb-0">@Localizer["Detecting location..."]</p>
                    <p class="small text-muted">@Localizer["Please allow GPS access if prompted."]</p>
                </div>
            `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeather(`${latitude},${longitude}`);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.code, error.message);
                        // Automatic fallback on any error (denied, unavailable, timeout)
                        this.detectLocationByIP();
                    },
                    { 
                        timeout: 5000,
                        enableHighAccuracy: true 
                    }
                );
            } else {
                this.detectLocationByIP();
            }
        }

        async function detectLocationByIP() {
            const content = document.getElementById('weather-content');
            try {
                // Using ipapi.co for free IP-based geolocation
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error('IP detection failed');
                const data = await res.json();
                
                if (data.latitude && data.longitude) {
                    console.log('IP Location fallback success:', data.city);
                    fetchWeather(`${data.latitude},${data.longitude}`);
                } else {
                    throw new Error('Incomplete data from IP service');
                }
            } catch (ipError) {
                console.error('IP Fallback failed:', ipError);
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-geo-alt-fill text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Location blocked by browser."]</p>
                        <p class="small text-muted mb-3">@Localizer["Your browser has blocked location access. Please search for your city manually above or reset site permissions."]</p>
                        <button onclick="detectLocationAndFetchWeather()" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                            <i class="bi bi-arrow-clockwise me-1"></i> @Localizer["Try Again"]
                        </button>
                    </div>
                `;
            }
        }

        async function fetchWeather(location = '') {
            const content = document.getElementById('weather-content');
            
            if (!location) {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-search text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Ready to search."]</p>
                        <p class="small text-muted">@Localizer["Enter a city to see the weather."]</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center p-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="small text-muted">@Localizer["Fetching weather data..."]</span>
                </div>
            `;

            try {
                // Using backend proxy to avoid CORS issues
                const response = await fetch(`/Dashboard/GetWeather?location=${encodeURIComponent(location || '')}`);
                if (!response.ok) throw new Error('Location not found');
                const data = await response.json();

                if (data.success === false) {
                    throw new Error(data.message || 'Failed to fetch weather');
                }
                
                const current = data?.current_condition?.[0] || {};
                const weatherToday = data?.weather?.[0] || {};
                const astronomy = weatherToday?.astronomy?.[0] || { sunrise: '--', sunset: '--' };
                const area = data?.nearest_area?.[0] || { areaName: [{ value: 'Unknown' }] };
                
                // Safe extraction of precipitation chance
                const chanceOfRain = (weatherToday?.hourly?.[0]?.chanceofrain || '0') + '%';
                
                // Display logic
                let displayName = '';
                if (location && !location.includes(',')) {
                    // Manual city search
                    displayName = location.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                } else {
                    // Coordinates or IP-based detection
                    displayName = area.areaName?.[0]?.value || '@Localizer["Current Location"]';
                }

                const countryName = area.country?.[0]?.value || '';
                const fullLocation = countryName ? `${displayName}, ${countryName}` : displayName;

                const weatherDesc = current?.lang_current?.[0]?.value || current?.weatherDesc?.[0]?.value || '@Localizer["Unknown"]';
                const now = new Date();
                const lastUpdated = now.toLocaleTimeString(window.APP_CULTURE, { hour: '2-digit', minute: '2-digit' });
                
                content.innerHTML = `
                    <div class="weather-main mb-4">
                        <div class="display-4 fw-bold text-primary mb-0">${current?.temp_C || '--'}C</div>
                        <div class="small fw-semibold text-muted mb-2"><i class="bi bi-thermometer-half"></i> @Localizer["Accurate Celsius"]</div>
                        <div class="fs-5 fw-semibold text-dark text-capitalize lh-sm mb-1">${weatherDesc}</div>
                        <div class="small text-muted mb-2">@Localizer["RealFeel"]: ${current?.FeelsLikeC || '--'}C</div>
                        ${location && location.includes(',') ? '<div class="badge bg-info bg-opacity-10 text-info mt-1"><i class="bi bi-crosshair me-1"></i> @Localizer["Current Location"]</div>' : ''}
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunrise"]</span>
                                <span class="fw-bold small text-warning"><i class="bi bi-sunrise me-1"></i>${astronomy.sunrise}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunset"]</span>
                                <span class="fw-bold small text-danger"><i class="bi bi-sunset me-1"></i>${astronomy.sunset}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["UV Index"]</span>
                                <span class="fw-bold small text-primary">${current?.uvIndex || '0'}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-info bg-opacity-10 border border-info border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Pressure"]</span>
                                <span class="fw-bold small text-info">${current?.pressure || '--'} hPa</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Humidity"]</span>
                                <span class="fw-bold small text-success">${current?.humidity || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Rain Chance"]</span>
                                <span class="fw-bold small text-warning-emphasis"><i class="bi bi-cloud-rain me-1"></i>${chanceOfRain}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Cloud Cover"]</span>
                                <span class="fw-bold small text-secondary-emphasis"><i class="bi bi-clouds me-1"></i>${current?.cloudcover || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/${encodeURIComponent(fullLocation)}" 
                       target="_blank" 
                       class="location-info p-2 rounded-pill bg-light mb-3 mx-auto d-inline-block px-4 text-decoration-none text-dark hover-link border"
                       title="@Localizer["View on Google Maps"]">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                        <span class="fw-medium">${fullLocation}</span>
                    </a>
                    
                    <div class="d-flex justify-content-between px-3 py-2 border-top mt-2">
                        <div class="text-center">
                            <i class="bi bi-thermometer-low text-primary d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.mintempC || '--'}C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-thermometer-high text-danger d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.maxtempC || '--'}C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-wind text-secondary d-block"></i>
                            <span class="smaller fw-bold">${current?.windspeedKmph || '0'} @Localizer["km/h"]</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-eye-fill text-warning d-block"></i>
                            <span class="smaller fw-bold">${current?.visibility || '0'} @Localizer["km"]</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="smaller text-muted" style="font-size: 0.7rem;">
                            <i class="bi bi-arrow-repeat me-1"></i>@Localizer["Last updated:"] ${lastUpdated}
                        </span>
                    </div>
                `;
                // Trigger translation for the weather card content
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(content);
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger py-3 px-3 small rounded-4 mx-2 text-center shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                        <p class="mb-2">@Localizer["Could not load weather for"] "${location}".</p>
                        <button onclick="fetchWeather('${location}')" class="btn btn-danger btn-sm rounded-pill px-4">
                            <i class="bi bi-arrow-clockwise me-1"></i> @Localizer["Retry"]
                        </button>
                    </div>
                `;
                console.error('Weather error:', error);
            }
        }

        function updateWeather() {
            const location = document.getElementById('location-input').value.trim();
            fetchWeather(location);
        }
// Goal Management Functions
function saveNewGoal(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    $.post('/Dashboard/AddGoal', Object.fromEntries(formData), function(res) {
        if (res.success) location.reload();
        else alert(res.message);
    });
}

function updateDailyLog(goalId, date, actual) {
    $.post('/Dashboard/UpdateDailyLog', { goalId, date, actual: parseFloat(actual) || 0 }, function(res) {
        if (res.success) {
            // Briefly show success feedback or just reload for simplicity
            // To be more responsive, we could update the UI elements directly
            location.reload();
        } else {
            alert(res.message);
        }
    });
}

function toggleGoalCompletion(id) {
    $.post('/Dashboard/ToggleGoalCompletion', { id }, function(res) {
        if (res.success) location.reload();
    });
}

function openEditGoalModal(id, title, start, end, category, priority, difficulty, target, current) {
    $('#editGoalId').val(id);
    $('#editGoalTitle').val(title);
    $('#editGoalStart').val(start);
    $('#editGoalEnd').val(end);
    $('#editGoalCategory').val(category);
    $('#editGoalPriority').val(priority);
    $('#editGoalDifficulty').val(difficulty);
    $('#editGoalTarget').val(target);
    $('#editTargetPreview').html('');
    const modal = new bootstrap.Modal(document.getElementById('editGoalModal'));
    modal.show();
}

function saveEditedGoal(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    $.post('/Dashboard/EditGoal', Object.fromEntries(formData), function(res) {
        if (res.success) location.reload();
        else alert(res.message);
    });
}

// Analytics and Reporting Functions
function openAnalytics() {
    $.get('/Dashboard/GetCategoryAnalytics', function(data) {
        const container = $('#analytics-container');
        container.empty();
        
        data.forEach((item, index) => {
            const chartId = `category-chart-${index}`;
            const card = `
                <div class="col-md-6 analytic-card">
                    <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light animate__animated animate__zoomIn" style="animation-delay: ${index * 0.1}s">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold mb-0 text-primary">${item.category}</h6>
                            <span class="badge bg-white text-dark shadow-sm rounded-pill">${item.count} Goals</span>
                        </div>
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col-5">
                                <div style="height: 80px; width: 80px;">
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            </div>
                            <div class="col-7">
                                <div class="smaller text-muted mb-1">Avg Progress: <strong>${item.avgProgress.toFixed(1)}%</strong></div>
                                <div class="smaller text-muted mb-1">Avg Health: <strong>${item.avgHealth.toFixed(1)}%</strong></div>
                                <div class="progress rounded-pill" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: ${item.avgProgress}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-1 mt-2">
                            ${item.statusSummary.map(s => `
                                <span class="badge bg-white border text-muted smaller animate__animated animate__fadeIn" style="font-size: 0.55rem;">
                                    ${s.status}: ${s.count}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.append(card);
            
            // Render doughnut chart for status distribution
            setTimeout(() => {
                const ctx = document.getElementById(chartId).getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: item.statusSummary.map(s => s.status),
                        datasets: [{
                            data: item.statusSummary.map(s => s.count),
                            backgroundColor: [
                                '#0d6efd', '#28a745', '#ffc107', '#dc3545', '#17a2b8'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }, 300);
        });
        
        const modal = new bootstrap.Modal(document.getElementById('categoryAnalyticsModal'));
        modal.show();
    });
}

function generateWeeklyReport() {
    const element = document.getElementById('analytics-container');
    const title = `<h2 class='text-center mb-4 fw-bold' style='color: #2575fc'>Weekly Goal Performance Report</h2>
                   <p class='text-center text-muted'>Generated on ${new Date().toLocaleDateString()}</p>`;
    
    // Create a temporary clone for professional PDF layout
    const clone = element.cloneNode(true);
    const wrapper = document.createElement('div');
    wrapper.style.padding = '40px';
    wrapper.innerHTML = title;
    wrapper.appendChild(clone);
    
    const opt = {
        margin:       0.5,
        filename:     'Weekly_Goal_Report.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().from(wrapper).set(opt).save();
}

function extendDeadline(id) {
    const days = prompt("How many additional days do you need?", "7");
    if (days && !isNaN(days)) {
        $.post('/Dashboard/ExtendGoalDeadline', { id, additionalDays: parseInt(days) }, function(res) {
            if (res.success) location.reload();
            else alert(res.message);
        });
    }
}

// Line Graph Visualization
function showGoalGraph(goalId, labels, expectedData, actualData) {
    const ctx = document.getElementById(`graph-${goalId}`).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Expected',
                data: expectedData,
                borderColor: 'rgba(0, 123, 255, 0.5)',
                borderDash: [5, 5],
                fill: false,
                tension: 0.1
            }, {
                label: 'Actual',
                data: actualData,
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function calculateDailyTarget(prefix) {
    // Calculation result display removed as requested
}

function initGoalChart(id, labels, targets, actuals) {
    setTimeout(() => {
        showGoalGraph(id, labels, targets, actuals);
    }, 200);
}

function deleteGoal(id) {
    if (confirm('Are you sure you want to remove this mission?')) {
        $.post('/Dashboard/DeleteGoal', { id }, function(res) {
            if (res.success) location.reload();
        });
    }
}

// Real-time Countdown Timer Logic
function updateTimers() {
    $('.countdown-timer').each(function() {
        const endDateStr = $(this).data('end-date');
        const endDate = new Date(endDateStr);
        // Add 1 day to end date to represent the "end" of that day (inclusive deadline)
        const deadline = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate() + 1);
        const now = new Date();
        const diff = deadline - now;

        if (diff <= 0) {
            $(this).find('.days').text('00');
            $(this).find('.hours').text('00');
            $(this).find('.minutes').text('00');
            $(this).siblings('.badge').text('Late').addClass('bg-danger');
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        $(this).find('.days').text(String(days).padStart(2, '0'));
        $(this).find('.hours').text(String(hours).padStart(2, '0'));
        $(this).find('.minutes').text(String(minutes).padStart(2, '0'));
        
        // Show seconds if less than an hour remains
        if (days === 0 && hours === 0) {
            $(this).find('.minutes-label').text(window.Localizer_Seconds || 'Secs');
            $(this).find('.minutes').text(String(seconds).padStart(2, '0'));
        }
    });
}

// Browser Notification logic
function checkGoalReminders() {
    $('.goal-item').each(function() {
        const title = $(this).find('h6').text();
        const statusBadge = $(this).find('.badge').first();
        const status = statusBadge.text().trim();
        
        if (status === 'Behind' || status === 'At Risk' || status === 'Late') {
            if ("Notification" in window) {
                if (Notification.permission === "granted") {
                    // Only notify if not already notified in this session
                    if (!window.sessionStorage.getItem('notified-' + title)) {
                        new Notification("Goal Attention Required", {
                            body: `Your mission "${title}" is ${status}. Stay focused!`,
                            icon: "/favicon.ico"
                        });
                        window.sessionStorage.setItem('notified-' + title, 'true');
                    }
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }
        }
    });
}

// Start timers and update every second for high precision
$(document).ready(function() {
    updateTimers();
    setInterval(updateTimers, 1000);
    
    // Check reminders after 5 seconds to not overwhelm
    setTimeout(checkGoalReminders, 5000);

    // Attach listeners for live calculator
    $(document).on('change input', '#addGoalForm input', () => calculateDailyTarget('add'));
    $(document).on('change input', '#editGoalForm input', () => calculateDailyTarget('edit'));
});

        // --- Currency Logic ---
        let currencyInfoMap = {};

        async function initCurrencies() {
            try {
                // Fetch exchange rates and country info in parallel
                const [rateRes, countryRes] = await Promise.all([
                    fetch('https://open.er-api.com/v6/latest/USD'),
                    fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2')
                ]);

                const rateData = await rateRes.json();
                const countryData = await countryRes.json();
                
                if (rateData.result === "success") {
                    let currencyOptions = [];

                    // Process country data
                    countryData.forEach(country => {
                        if (country.currencies) {
                            Object.entries(country.currencies).forEach(([code, details]) => {
                                // Include all countries, even if rate is missing
                                currencyOptions.push({
                                    countryName: country.name.common,
                                    countryCode: country.cca2,
                                    currencyCode: code,
                                    currencyName: details.name,
                                    flag: country.flags.svg,
                                    // Unique value for select option to prevent jumping
                                    value: `${code}|${country.cca2}`
                                });

                                // Store info for display
                                currencyInfoMap[`${code}|${country.cca2}`] = {
                                    name: details.name,
                                    symbol: details.symbol,
                                    flag: country.flags.svg,
                                    country: country.name.common
                                };
                            });
                        }
                    });

                    // Sort by country name
                    currencyOptions.sort((a, b) => a.countryName.localeCompare(b.countryName));

                    const fromSelect = document.getElementById('from-currency');
                    const toSelect = document.getElementById('to-currency');
                    
                    const populateSelect = (select, defaultCountryCode, defaultCurrencyCode) => {
                        select.innerHTML = '';
                        let defaultFound = false;
                        
                        currencyOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = `${opt.countryName} - ${opt.currencyName} (${opt.currencyCode})`;
                            select.appendChild(option);

                            // auto-select defaults (US for USD, IN for INR)
                            if (!defaultFound && opt.countryCode === defaultCountryCode && opt.currencyCode === defaultCurrencyCode) {
                                select.value = opt.value;
                                defaultFound = true;
                            }
                        });
                    };

                    populateSelect(fromSelect, 'US', 'USD');
                    populateSelect(toSelect, 'IN', 'INR');
                }
            } catch (error) {
                console.error('Failed to load currencies:', error);
            }
        }

        async function convertCurrency() {
            const amountInput = document.getElementById('amount');
            const amount = amountInput.value || 1;
            // Value format is "CODE|COUNTRY_CODE"
            const fromValue = document.getElementById('from-currency').value;
            const toValue = document.getElementById('to-currency').value;
            
            if (!fromValue || !toValue) return;

            const fromCode = fromValue.split('|')[0];
            const toCode = toValue.split('|')[0];
            
            const resDiv = document.getElementById('currency-result');

            resDiv.innerHTML = `
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="small text-muted">@Localizer["Calculating..."]</span>
                </div>
            `;

            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${fromCode}`);
                const data = await response.json();
                
                if (data.result === "success") {
                    const rate = data.rates[toCode];
                    
                    if (rate !== undefined) {
                        const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        
                        const fromInfo = currencyInfoMap[fromValue];
                        const toInfo = currencyInfoMap[toValue];

                        if (!fromInfo || !toInfo) {
                            resDiv.innerHTML = '<div class="text-warning small text-center"><i class="bi bi-exclamation-circle me-1"></i> @Localizer["Currency info unavailable"]</div>';
                            return;
                        }

                        const symbol = (toInfo.symbol && toInfo.symbol !== 'undefined') ? toInfo.symbol : '';
                        const currencyName = toInfo.currencyName || '';
                        const countryName = toInfo.country || '';
                        
                        resDiv.innerHTML = `
                            <div class="text-start">
                                <div class="small text-muted mb-1">
                                    <img src="${fromInfo.flag}" class="flag-icon me-1" style="width: 20px; height: 15px; vertical-align: middle;">
                                    ${amount} ${fromInfo.country} (${fromCode}) @Localizer["equals"]
                                </div>
                                <div class="h3 fw-bold mb-0">
                                    <img src="${toInfo.flag}" class="flag-icon me-1" style="width: 30px; height: 22px; vertical-align: baseline;">
                                    ${symbol} ${converted} 
                                </div>
                                <div class="fw-medium text-dark small">${currencyName}</div>
                                <div class="small text-muted">@Localizer["in"] ${countryName}</div>
                            </div>
                        `;
                        // Trigger translation for currency result
                        if (window.TranslationManager) {
                            window.TranslationManager.translateElement(resDiv);
                        }
                    } else {
                        resDiv.innerHTML = '<div class="text-warning small text-center"><i class="bi bi-exclamation-circle me-1"></i> @Localizer["Exchange rate unavailable"]</div>';
                        console.warn(`Rate not found for ${toCode}`);
                    }
                } else {
                    resDiv.innerHTML = ''; // Silently fail
                    console.warn('Error fetching rates');
                }
            } catch (error) {
                resDiv.innerHTML = ''; // Silently fail
                console.error('Currency error:', error);
            }
        }

        // --- Time Logic ---
        let currentTargetTimezone = 'UTC';
        let currentTargetLocationName = 'UTC (GMT)';
        const searchCache = new Map(); // Cache for search results

        let searchTimeout;
        async function handleGlobalSearch() {
            const query = document.getElementById('timezone-search').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 3) {
                resultsDiv.classList.add('d-none');
                return;
            }

            // Check Cache
            if (searchCache.has(query.toLowerCase())) {
                renderSearchResults(searchCache.get(query.toLowerCase()));
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    // Single API call for Location + Timezone
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item small text-muted text-center py-3">@Localizer["No location found"]</div>';
                        resultsDiv.classList.remove('d-none');
                        return;
                    }

                    // Cache results
                    searchCache.set(query.toLowerCase(), data.results);
                    renderSearchResults(data.results);

                } catch (error) {
                    console.error('Geo search error:', error);
                }
            }, 300); 
        }

        function renderSearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            const input = document.getElementById('timezone-search');
            
            // --- Auto-select first result (Optimistic) ---
            const first = results[0];
            updateTimezoneFromData(first, false); // Don't update input text yet

            // --- Populate dropdown ---
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('d-none');
            
            results.forEach(item => {
                const name = item.name;
                const country = item.country || '';
                const admin1 = item.admin1 || '';
                const details = [admin1, country].filter(x => x && x !== name).join(', ');
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action small py-2 px-3 border-0';
                btn.innerHTML = `
                    <div class="fw-bold text-start">${name}</div>
                    <div class="smaller text-muted text-start">${details}</div>
                `;
                
                btn.onclick = () => {
                    resultsDiv.classList.add('d-none');
                    input.value = `${name}, ${country}`;
                    updateTimezoneFromData(item, true);
                };
                resultsDiv.appendChild(btn);
            });
            
            // Trigger translation for search results
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(resultsDiv);
            }
        }

        function updateTimezoneFromData(item, updateLabel) {
            if (item.timezone) {
                currentTargetTimezone = item.timezone;
                currentTargetLocationName = `${item.name}, ${item.country || ''}`;
                updateTargetTime();
            }
        }



        function getCurrentCulture() {
            // Prefer TranslationManager's language if available, else fallback to server culture
            if (window.TranslationManager && window.TranslationManager.currentLang) {
                // Formatting needs full locale sometimes, but 'es', 'fr' etc usually work for Date
                return window.TranslationManager.currentLang; 
            }
            return window.APP_CULTURE || 'en-US';
        }

        function updateTimes() {
            const now = new Date();
            const culture = getCurrentCulture();
            document.getElementById('local-time').innerText = now.toLocaleTimeString(culture, { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            updateTargetTime();
        }

        function updateTargetTime() {
            const timezone = currentTargetTimezone;
            const targetTimeDiv = document.getElementById('target-time');
            const targetDateDiv = document.getElementById('target-date');
            const relativeDayDiv = document.getElementById('relative-day');
            const locationDisplay = document.getElementById('target-location-display');

            if (locationDisplay) locationDisplay.innerText = currentTargetLocationName;

            if (!timezone) {
                // ... (fallback)
                return;
            }

            const now = new Date();
            const culture = getCurrentCulture();
            try {
                // Time
                const targetTimeStr = now.toLocaleTimeString(culture, { 
                    timeZone: timezone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true
                });
                targetTimeDiv.innerText = targetTimeStr;

                // Date
                const options = { timeZone: timezone, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const targetDateStr = now.toLocaleDateString(culture, options);
                targetDateDiv.innerText = targetDateStr;

                // Relative Day logic
                const localDateStr = now.toLocaleDateString('en-US'); // Keep calculation logic stable in EN
                const targetDateSimpleStr = now.toLocaleDateString('en-US', { timeZone: timezone });
                
                const localDate = new Date(localDateStr);
                const targetDate = new Date(targetDateSimpleStr);
                
                const diffTime = targetDate - localDate;
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                relativeDayDiv.className = 'badge rounded-pill mt-2';
                let dayText = "";
                if (diffDays === 0) {
                    relativeDayDiv.innerText = "";
                } else if (diffDays > 0) {
                    dayText = "@Localizer["Tomorrow"]";
                    relativeDayDiv.classList.add('badge-tomorrow');
                } else { // diffDays < 0
                    dayText = "@Localizer["Yesterday"]";
                    relativeDayDiv.classList.add('badge-yesterday');
                }
                
                if(dayText) {
                    relativeDayDiv.innerText = dayText;
                    // Trigger dynamic translation only for the relative day badge text
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(relativeDayDiv);
                    }
                }

            } catch (e) {
                targetTimeDiv.innerText = "@Localizer["Error"]";
                targetDateDiv.innerText = "";
                relativeDayDiv.innerText = "";
            }
        }




        // --- News Logic ---
        async function fetchNews(query = '') {
            const container = document.getElementById('news-container');
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-danger spinner-border-sm" role="status"></div>
                    <p class="mt-2 text-muted small">@Localizer["Fetching global news..."]</p>
                </div>
            `;
            
            try {
                const url = query ? `/News/GetGlobalNews?q=${encodeURIComponent(query)}` : '/News/GetGlobalNews';
                const response = await fetch(url); 
                const data = await response.json();
                
                if (data.status === 'ok' && data.articles) {
                    container.innerHTML = '';
                    const articles = data.articles;
                    
                    if (articles.length === 0) {
                        container.innerHTML = `<div class="text-center py-5 text-muted small">@Localizer["No global news found."]</div>`;
                        return;
                    }

                    let html = '<div class="d-flex flex-column gap-3">';
                    articles.forEach((article) => {
                        const imgUrl = article.urlToImage || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop';
                        const date = new Date(article.publishedAt).toLocaleString(undefined, { 
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        });
                        
                        html += `
                            <div class="news-item-compact p-2 rounded-3 border bg-light bg-opacity-50 position-relative transition-all hover-elevate">
                                <div class="d-flex gap-3">
                                    <div class="flex-shrink-0" style="width: 70px; height: 70px;">
                                        <img src="${imgUrl}" class="rounded-3 w-100 h-100 object-fit-cover shadow-sm" alt="News" 
                                             referrerpolicy="no-referrer" loading="lazy"
                                             onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop'">
                                    </div>
                                    <div class="flex-grow-1 min-width-0">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10 smaller" style="font-size: 0.6rem;">
                                                ${article.source.name}
                                            </span>
                                            <span class="smaller text-muted" style="font-size: 0.6rem;">${date}</span>
                                        </div>
                                        <h6 class="fw-bold mb-0 text-dark line-clamp-2" style="font-size: 0.78rem; line-height: 1.3;">
                                            <a href="${article.url}" target="_blank" class="text-decoration-none text-dark stretched-link">${article.title}</a>
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                    
                    // Trigger translation
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(container);
                    }
                } else {
                    const msg = data.message || '@Localizer["Unable to load news."]';
                    container.innerHTML = `<div class="text-center py-5 text-muted small"><i class="bi bi-exclamation-circle me-1"></i>${msg}</div>`;
                }
            } catch (error) {
                console.error('News error:', error);
                container.innerHTML = `<div class="text-center py-5 text-muted small">@Localizer["Unable to load global news."]</div>`;
            }
        }

        async function saveNewNote() {
            const text = document.getElementById('new-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/AddNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Add note error:', error);
            }
        }

        function openEditModal(id, text) {
            document.getElementById('edit-note-id').value = id;
            document.getElementById('edit-note-text').value = text;
            const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            modal.show();
        }

        async function updateNote() {
            const id = document.getElementById('edit-note-id').value;
            const text = document.getElementById('edit-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/EditNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}&text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Update note error:', error);
            }
        }

        // --- World Countries logic ---
        let allCountries = [];

        async function fetchAllCountries() {
            const container = document.getElementById('country-container');
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,translations');
                if (!response.ok) throw new Error('API failed');
                allCountries = await response.json();
                
                // Helper to get name in current language
                allCountries.forEach(c => {
                    c.displayName = c.name.common;
                });

                // Sort alphabetically
                allCountries.sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                renderCountryList(allCountries);
            } catch (error) {
                console.error('Fetch all countries error:', error);
                console.error('Fetch all countries error:', error);
                if (container) container.innerHTML = `<div class="text-center py-5 text-muted small">@Localizer["Unable to load directory."]</div>`;
            }
        }
        
        
        // Removed local translation logic (uiLabels, getTranslatedCountryName) to rely on global TranslationManager.


        function renderCountryList(list) {
            const container = document.getElementById('country-container');
            const searchIcon = document.getElementById('country-search-icon');
            
            // Set icon to search by default
            const searchInput = document.getElementById('country-search-input');
            if (searchInput) {
                searchInput.placeholder = "@Localizer["Search country..."]";
            }

            if (searchIcon) {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null; // Reset to default if it was "X"
            }

            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-5 text-muted small">@Localizer["No results found."]</div>`;
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            list.forEach(c => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action d-flex align-items-center bg-transparent border-0 py-2 px-1" onclick="showCountryDetail('${c.cca3}')">
                        <img src="${c.flags.svg}" class="rounded-1 me-3 shadow-sm" style="width: 30px; height: 20px; object-fit: cover;">
                        <span class="small fw-medium">${c.displayName}</span>
                        <i class="bi bi-chevron-right ms-auto smaller text-muted opacity-50"></i>
                    </button>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // Trigger translation for country list
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(container);
            }
        }

        function filterCountries(query) {
            const searchIcon = document.getElementById('country-search-icon');
            if (query.trim()) {
                searchIcon.className = 'bi bi-x-lg';
                searchIcon.parentElement.onclick = showCountryList;
            } else {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null;
            }

            const filtered = allCountries.filter(c => 
                c.displayName.toLowerCase().includes(query.toLowerCase())
            );
            renderCountryList(filtered);
        }

        function showCountryList() {
            document.getElementById('country-search-input').value = '';
            renderCountryList(allCountries);
        }

        async function showCountryDetail(cca3) {
            const container = document.getElementById('country-container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                        <span class="visually-hidden">@Localizer["Loading..."]</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`https://restcountries.com/v3.1/alpha/${cca3}`);
                if (!response.ok) throw new Error('Details not found');
                const data = await response.json();
                const country = data[0];

                const name = country.name.common;
                const flag = country.flags.svg;
                const capital = country.capital ? country.capital[0] : 'N/A';
                const region = country.region;
                const population = country.population.toLocaleString(window.APP_CULTURE);
                const currencies = country.currencies ? Object.values(country.currencies).map(c => `${c.name} (${c.symbol})`).join(', ') : 'N/A';
                const languages = country.languages ? Object.values(country.languages).join(', ') : 'N/A';
                const timezones = country.timezones ? country.timezones[0] : 'N/A';

                container.innerHTML = `
                    <div class="country-details mt-2">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" onclick="showCountryList()" style="font-size: 0.7rem;">
                                <i class="bi bi-arrow-left me-1"></i> @Localizer["Back"]
                            </button>
                        </div>
                        <div class="text-center mb-3">
                            <img src="${flag}" class="shadow-sm rounded-3" style="width: 100%; max-height: 120px; object-fit: cover; border: 1px solid #eee;">
                            <h5 class="fw-bold mt-2 mb-0">${name}</h5>
                            <span class="badge bg-light border smaller">${region}</span>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">@Localizer["Capital"]</span>
                                    <span class="fw-bold small">${capital}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">@Localizer["Population"]</span>
                                    <span class="fw-bold small">${population}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">@Localizer["Currency"]</span>
                                    <span class="fw-bold small" style="font-size: 0.65rem;">${currencies}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">@Localizer["Timezone"]</span>
                                    <span class="fw-bold small">${timezones}</span>
                                </div>
                            </div>
                            <div class="col-12 mt-1">
                                <div class="p-2 rounded-3 bg-light border text-center">
                                    <span class="d-block smaller text-muted">@Localizer["Language"]</span>
                                    <span class="fw-bold small">${languages}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.scrollTop = 0; // Reset scroll
                // Trigger translation for country details
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(container);
                }
            } catch (error) {
                console.error('Country details error:', error);
                container.innerHTML = `<div class="text-center py-5 text-muted small">@Localizer["Unable to load details."]</div>`;
            }
        }


        async function deleteNote(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this note?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete note error:', error);
            }
        }

        // --- Habit Logic ---
        function toggleCustomDays(show) {
            const container = document.getElementById('customDaysContainer');
            if (show) {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        }

        async function saveNewHabit() {
            const name = document.getElementById('habit-name').value;
            const desc = document.getElementById('habit-desc').value;
            const startDate = document.getElementById('habit-start-date').value;
            
            const isCustom = document.getElementById('freqCustom').checked;
            const frequency = isCustom ? "Custom" : "Daily";
            
            let customDays = [];
            if (isCustom) {
                document.querySelectorAll('.custom-day-check:checked').forEach(cb => {
                    customDays.push(cb.value);
                });
            }

            console.log('Saving Habit:', { name, desc, frequency, customDays, startDate });

            if (!name.trim()) {
                alert('@Localizer["Please enter a habit name."]');
                return;
            }

            try {
                const response = await fetch('/Dashboard/AddHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}&frequency=${frequency}&customDays=${customDays.join(',')}&startDate=${startDate}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Add habit error:', error);
                alert('@Localizer["An error occurred while adding the habit."]');
            }
        }

        async function toggleHabit(id) {
            try {
                const response = await fetch('/Dashboard/ToggleHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Toggle habit error:', error);
            }
        }

        async function deleteHabit(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this habit?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete habit error:', error);
            }
        }

        // --- Emergency Numbers Logic ---
        let emergencyCountries = []; // Will share structure with allCountries roughly

        async function initEmergencySection() {
            // Need country list. If fetchAllCountries already ran, use it.
            // If strictly needed, wait or check. 
            // We can reuse 'allCountries' from World Countries logic if confirmed loaded
            // Or just check if empty and re-fetch if needed.
            
            if (allCountries.length === 0) {
              // Should be loaded by fetchAllCountries, but let's be safe
               try {
                  const response = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,translations'); 
                  const data = await response.json();
                  emergencyCountries = data.sort((a, b) => a.name.common.localeCompare(b.name.common));
               } catch(e) { console.error(e); }
            } else {
                emergencyCountries = allCountries;
            }
        }

        function filterEmergencyCountries(query) {
             const listDiv = document.getElementById('emergency-country-list');
             if (!query || query.length < 2) {
                 listDiv.classList.add('d-none');
                 return;
             }
             
             // Use same translation helper
             const filtered = emergencyCountries.filter(c => {
                 const name = c.name.common;
                 return name.toLowerCase().includes(query.toLowerCase());
             }).slice(0, 5); // Limit to 5
             
             if (filtered.length === 0) {
                 listDiv.innerHTML = `<div class="p-2 small text-muted text-center">@Localizer["No results"]</div>`;
                 listDiv.classList.remove('d-none');
                 return;
             }
             
             let html = '';
             filtered.forEach(c => {
                 const name = c.name.common;
                 html += `
                    <button type="button" class="list-group-item list-group-item-action border-0 px-3 py-2 d-flex align-items-center" onclick="selectEmergencyCountry('${c.cca3}', '${name.replace(/'/g, "\\'")}', '${c.flags.svg}')">
                        <img src="${c.flags.svg}" class="me-2 rounded-1 border" style="width: 20px; height: 15px; object-fit: cover;">
                        <span class="small fw-medium">${name}</span>
                    </button>
                 `;
             });
             
             listDiv.innerHTML = html;
             listDiv.classList.remove('d-none');
        }
        function updateTranslatorState() {
            const source = document.getElementById('translator-source-lang').value;
            const target = document.getElementById('translator-target-lang').value;
            const input = document.getElementById('translator-input');
            const btn = document.getElementById('translator-btn');
            
            if (source && target) {
                input.disabled = false;
                btn.disabled = false;
                input.placeholder = "@Localizer["Now enter text to translate..."]";
            } else {
                input.disabled = true;
                btn.disabled = true;
                input.placeholder = "@Localizer["Select input language first..."]";
            }
        }

        async function initTranslator() {
            try {
                const response = await fetch('/api/translation/languages');
                if (response.ok) {
                    const languages = await response.json();
                    const sourceSelect = document.getElementById('translator-source-lang');
                    const targetSelect = document.getElementById('translator-target-lang');
                    
                    if (sourceSelect && targetSelect) {
                        languages.forEach(lang => {
                            const opt1 = new Option(lang.name, lang.code);
                            sourceSelect.add(opt1);
                            const opt2 = new Option(lang.name, lang.code);
                            targetSelect.add(opt2);
                        });
                    }
                }
            } catch (error) {
                console.error("Failed to load translator languages", error);
            }
        }

        async function performManualTranslation() {
            const input = document.getElementById('translator-input').value.trim();
            const sourceLang = document.getElementById('translator-source-lang').value;
            const targetLang = document.getElementById('translator-target-lang').value;
            const btn = document.getElementById('translator-btn');
            const errorDiv = document.getElementById('translator-error');
            const resultContainer = document.getElementById('translator-result-container');
            const outputDiv = document.getElementById('translator-output');

            errorDiv.classList.add('d-none');
            resultContainer.classList.add('d-none');
            
            if (!input || !sourceLang || !targetLang) {
                document.getElementById('translator-error-msg').innerText = "@Localizer["Please fill all fields."]";
                errorDiv.classList.remove('d-none');
                return;
            }

            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> @Localizer["Translating..."]';
            btn.disabled = true;

            try {
                const response = await fetch('/api/translation/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        texts: [input], 
                        targetLanguage: targetLang,
                        sourceLanguage: sourceLang 
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const translatedText = result[input];
                    if (translatedText) {
                        outputDiv.innerText = translatedText;
                        resultContainer.classList.remove('d-none');
                    } else {
                        throw new Error("Translation failed");
                    }
                } else {
                    throw new Error("Request failed");
                }
            } catch (error) {
                console.error("Manual translation error:", error);
                document.getElementById('translator-error-msg').innerText = "@Localizer["Translation failed."]";
                errorDiv.classList.remove('d-none');
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }


        function selectEmergencyCountry(cca3, name, flagUrl) {

            document.getElementById('emergency-country-search').value = name;
            document.getElementById('emergency-country-list').classList.add('d-none');
            
            document.getElementById('emergency-country-name').innerText = name;
            document.getElementById('emergency-flag').src = flagUrl;
            
            const data = window.emergencyData[cca3] || { police: '112', ambulance: '112', fire: '112', general: '112' }; // Fallback to 112 (EU/GSM standard)
            
            // Check if specific data exists, if not maybe show "Not available" or standard
            // My data set covers major ones.
            
            document.getElementById('emer-police').innerText = data.police || '--';
            document.getElementById('emer-ambulance').innerText = data.ambulance || '--';
            document.getElementById('emer-fire').innerText = data.fire || '--';
            document.getElementById('emer-general').innerText = data.general || '--';
            
            document.getElementById('emergency-placeholder').classList.add('d-none');
            document.getElementById('emergency-display').classList.remove('d-none');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ... existing listeners
            setTimeout(initEmergencySection, 2000); // Give time for main country fetch
            detectLocationAndFetchWeather(); // Detect and fetch
            initCurrencies();
            initTranslator();
            // initTimezones(); REMOVED
            window.timeUpdateInterval = setInterval(updateTimes, 1000);
            
            // Auto-refresh weather every 10 minutes ONLY if we have a location
            if (window.weatherRefreshInterval) clearInterval(window.weatherRefreshInterval);
            window.weatherRefreshInterval = setInterval(() => {
                const currentLoc = document.querySelector('.location-info .fw-medium')?.innerText;
                if (currentLoc) {
                    // Refresh current displayed location
                    fetchWeather(currentLoc);
                } else {
                    // Try to re-detect if nothing is shown
                    detectLocationAndFetchWeather();
                }
            }, 10 * 60 * 1000);
            
            updateTimes();
            // Initial conversion delayed slightly to allow currencies to load
            setTimeout(convertCurrency, 1000);
            
            fetchNews();
            fetchAllCountries();
            // Start listening for clicks outside to close dropdowns
            document.addEventListener('click', function(event) {
                const eList = document.getElementById('emergency-country-list');
                const eInput = document.getElementById('emergency-country-search');
                if (eList && !eList.contains(event.target) && event.target !== eInput) {
                    eList.classList.add('d-none');
                }
            });
        });

        // --- PDF Converter Logic ---
        function updateUploadAccept(format) {
            const input = document.getElementById('image-upload');
            input.accept = format;
            input.value = ''; // Reset input
            
            // Clean up state
            document.getElementById('selected-files-container').classList.add('d-none');
            document.getElementById('selected-files-list').innerHTML = '';
            document.getElementById('convert-to-pdf-btn').disabled = true;
            document.getElementById('image-format-error').classList.add('d-none');
        }

        function previewImage(input) {
            const filesContainer = document.getElementById('selected-files-container');
            const filesList = document.getElementById('selected-files-list');
            const filesCountBadge = document.getElementById('files-count-badge');
            const convertBtn = document.getElementById('convert-to-pdf-btn');
            const errorDiv = document.getElementById('image-format-error');
            const selectedFormat = document.getElementById('image-format-select').value;

            errorDiv.classList.add('d-none');
            filesList.innerHTML = '';

            if (input.files && input.files.length > 0) {
                let validFiles = true;
                const filePromises = [];
                
                // Validate first
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    if (!selectedFormat.includes(file.type)) {
                        validFiles = false;
                        break;
                    }
                }
                
                if (!validFiles) {
                    errorDiv.classList.remove('d-none');
                    input.value = '';
                    filesContainer.classList.add('d-none');
                    convertBtn.disabled = true;
                    return;
                }

                // Generate Previews
                filesList.className = 'd-flex flex-wrap gap-2 justify-content-center'; // Grid layout
                
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const reader = new FileReader();
                    
                    const promise = new Promise((resolve) => {
                        reader.onload = (e) => {
                            const div = document.createElement('div');
                            div.className = 'position-relative shadow-sm rounded-3 overflow-hidden border';
                            div.style.width = '80px';
                            div.style.height = '80px';
                            div.title = file.name;
                            
                            div.innerHTML = `
                                <img src="${e.target.result}" class="w-100 h-100 object-fit-cover">
                                <div class="position-absolute bottom-0 start-0 w-100 bg-dark bg-opacity-50 text-white text-center small py-0" style="font-size: 0.6rem;">${i+1}</div>
                            `;
                            filesList.appendChild(div);
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                    filePromises.push(promise);
                }

                filesCountBadge.textContent = `${input.files.length} ${input.files.length === 1 ? '@Localizer["image selected"]' : '@Localizer["images selected"]'}`;
                filesContainer.classList.remove('d-none');
                convertBtn.disabled = false;
            } else {
                filesContainer.classList.add('d-none');
                convertBtn.disabled = true;
            }
        }

        let generatedPdfBlob = null;
        let generatedPdfName = 'converted_images.pdf';

        function resetPdfConverter() {
            document.getElementById('image-upload').value = '';
            document.getElementById('selected-files-container').classList.add('d-none');
            document.getElementById('pdf-result-container').classList.add('d-none');
            document.getElementById('convert-btn-container').classList.remove('d-none');
            document.getElementById('selected-files-list').innerHTML = '';
            document.getElementById('convert-to-pdf-btn').disabled = true;
            generatedPdfBlob = null;
        }

        function openPdfInNewTab() {
            if (generatedPdfBlob) {
                const url = URL.createObjectURL(generatedPdfBlob);
                window.open(url, '_blank');
                // We don't revoke immediately so the tab can load it, 
                // but browser usually manages this for new tabs.
            }
        }

        function downloadPdf() {
            if (generatedPdfBlob) {
                const url = URL.createObjectURL(generatedPdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = generatedPdfName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        async function convertToPdf() {
            const { jsPDF } = window.jspdf;
            const input = document.getElementById('image-upload');
            const convertBtn = document.getElementById('convert-to-pdf-btn');
            const resultContainer = document.getElementById('pdf-result-container');
            const btnContainer = document.getElementById('convert-btn-container');
            const margin = parseInt(document.getElementById('pdf-margin-select').value) || 0;

            if (!input.files || input.files.length === 0) return;

            // Generate Professional Filename
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            generatedPdfName = `Document_${dateStr}.pdf`;

            const originalBtnContent = convertBtn.innerHTML;
            convertBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> @Localizer["Converting..."]';
            convertBtn.disabled = true;

            try {
                let doc = null;

                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const fileType = file.type === 'image/png' ? 'PNG' : 'JPEG';

                    const dataUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });

                    const img = new Image();
                    img.src = dataUrl;
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                    });

                    // Force Portrait A4 for a consistent document width
                    // A4 size: 210mm x 297mm
                    if (i === 0) {
                        doc = new jsPDF('p', 'mm', 'a4');
                    } else {
                        doc.addPage('a4', 'p');
                    }

                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    // Fixed content width based on margins
                    const maxWidth = pageWidth - (margin * 2);
                    const maxHeight = pageHeight - (margin * 2);
                    
                    // Standardize scale to fit the fixed width/height container
                    let ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
                    
                    const finalWidth = img.width * ratio;
                    const finalHeight = img.height * ratio;
                    
                    // Absolute centering on the A4 portrait canvas
                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;

                    doc.addImage(dataUrl, fileType, x, y, finalWidth, finalHeight);
                }
                
                if (doc) {
                    generatedPdfBlob = doc.output('blob');
                    btnContainer.classList.add('d-none');
                    resultContainer.classList.remove('d-none');
                }
                
            } catch (error) {
                console.error("PDF Conversion error:", error);
                alert("@Localizer["Failed to merge images to PDF."]");
            } finally {
                convertBtn.innerHTML = originalBtnContent;
                convertBtn.disabled = false;
            }
        }

    </script>
}
<!-- Analytics Modal -->
<div class="modal fade" id="categoryAnalyticsModal" tabindex="-1" aria-labelledby="categoryAnalyticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="categoryAnalyticsModalLabel">@Localizer["Category-Based Performance"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="analytics-container" class="row g-4">
                    <!-- Analytics will be loaded here -->
                </div>
                <div class="mt-4 pt-3 border-top d-flex justify-content-between">
                    <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="generateWeeklyReport()">
                        <i class="bi bi-file-earmark-pdf me-2"></i> @Localizer["Generate Weekly Report PDF"]
                    </button>
                    <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Close"]</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
